var App= require('general-express')
var app= module.exports= App()

var User= require('Example/models/User')
var UserEmail= require('Example/models/UserEmail')
var UserPhone= require('Example/models/UserPhone')



app.get('/', function * (req, res, next) {
    try {

        if (req.isAuthenticated()) {

            res.json(
                yield User.get(req.user)
            )

        } else {
            res.json(req.user, 401)
        }

    } catch (err) {
        next(err)
    }
})



app.post('/', App.json(), function * (req, res, next) {
    try {

        req.body.id= req.user.id

        if (req.body.deleted) {

            var user= yield User.del(req.body)
            if (user) {

                user.emails= yield UserEmail.del(user)
                user.phones= yield UserPhone.del(user)

                req.logout()
                res.json(user)

            } else {
                res.json(user, 404)
            }

        } else {

            var user= yield User.patch(req.body)
            if (user) {

                user.emails= yield UserEmail.patch(user, req.body.emails)
                user.phones= yield UserPhone.patch(user, req.body.phones)

                req.logout()
                res.json(user)

            } else {
                res.json(user, 404)
            }

        }

    } catch (err) {
        next(err)
    }
})
