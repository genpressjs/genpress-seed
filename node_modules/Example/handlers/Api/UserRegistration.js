var App= require('genpress')
var app= module.exports= App()

var User= require('Example/models/User')
var UserEmail= require('Example/models/UserEmail')
var UserPhone= require('Example/models/UserPhone')



/**
 *
 * User registration
 *
 * Example of request body:
 *
 * >>> Content-Type: application/json
 * >>>
 * >>> {
 * >>>   "name": "tehfreak",
 * >>>   "pass": "Passw0rd",
 * >>>   "emails": [{
 * >>>       "value": "tehfreak@awesome39.com"
 * >>>     },{
 * >>>       "value": "tehfreak@tehfreak.com"
 * >>>   }],
 * >>>   "phones": [{
 * >>>       "value": "+79216038103"
 * >>>   }]
 * >>> }
 *
 * Example of response body:
 *
 * <<< Content-Type: application/json
 * <<< {
 * <<<   "id": 1,
 * <<<   "updatedAt": "Thu Mar 20 2014 19:27:22 GMT+0300",
 * <<<   "emails": [{
 * <<<       "id": 1,
 * <<<       "value": "tehfreak@awesome39.com",
 * <<<       "updatedAt": "Thu Mar 20 2014 19:27:22 GMT+0300",
 * <<<       "verifiedAt": null
 * <<<     },{
 * <<<       "id": 2,
 * <<<       "value": "tehfreak@tehfreak.com",
 * <<<       "updatedAt": "Thu Mar 20 2014 19:27:22 GMT+0300",
 * <<<       "verifiedAt": null
 * <<<   }],
 * <<<   "phones": [{
 * <<<       "id": 1,
 * <<<       "value": "+79216038103",
 * <<<       "updatedAt": "Thu Mar 20 2014 19:27:23 GMT+0300",
 * <<<       "verifiedAt": null
 * <<<   }]
 * <<< }
 *
 */
app.post('/', App.Express.json(), function * (req, res, next) { var user
    try {

        // SAVE...
        try {

            // begin transaction

            req.body.id= 0

            user= yield User.post(req.body) // save new User...
            user.emails= yield UserEmail.push(user, req.body.emails) // save new UserEmail`s...
            user.phones= yield UserPhone.push(user, req.body.phones) // save new UserPhone`s...

            // commit

        } catch (err) { // NOT SAVED...

            // rollback transaction

            if (err instanceof User.ExistsError) { // NOT SAVED: Username exists.
                return res.json(req.body, 400)
            }
            if (err instanceof UserEmail.ExistsError) { // NOT SAVED: Email exists.
                return res.json(req.body, 400)
            }
            if (err instanceof UserPhone.ExistsError) { // NOT SAVED: Phone exists.
                return res.json(req.body, 400)
            }

            throw err // NOT SAVED.
        }
        // SAVED.

        // SAVE VERIFICATION CODES...
        try {

            // begin transaction

            user.emails= yield UserEmail.check(user) // verify saved UserEmail`s...
            user.phones= yield UserPhone.check(user) // verify saved UserPhone`s...

            // commit

        } catch (err) {

            // rollback transaction

            throw err // NOT SAVED.
        }
        // SAVED VERIFICATION CODES.

        res.json(user)

    } catch (err) {
        next(err)
    }
})



/**
 *
 * User verify emails
 *
 */
app.get('/emails/:code', App.Express.json(), function * (req, res, next) { var code
    try {

        code= req.param('code')

        // CHECK VERIFICATION CODE...
        try {

            // begin transaction

            code= yield UserEmail.checkCode(code) // check saved UserEmail code...

            // commit

        } catch (err) {

            // rollback transaction

            throw err // NOT CHECKED.
        }
        // CHECKED VERIFICATION CODE.

        res.json(code)

    } catch (err) {
        next(err)
    }
})



/**
 *
 * User verify phones
 *
 */
app.get('/phones/:code', App.Express.json(), function * (req, res, next) { var code
    try {

        code= req.param('code')

        // CHECK VERIFICATION CODE...
        try {

            // begin transaction

            code= yield UserPhone.checkCode(code) // check saved UserPhone code...

            // commit

        } catch (err) {

            // rollback transaction

            throw err // NOT CHECKED.
        }
        // CHECKED VERIFICATION CODE.

        res.json(code)

    } catch (err) {
        next(err)
    }
})
