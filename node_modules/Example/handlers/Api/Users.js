var App= require('general-express')
var app= module.exports= App()

var User= require('Example/models/User')
var UserEmail= require('Example/models/UserEmail')
var UserPhone= require('Example/models/UserPhone')



app.get('/', function * (req, res, next) {
    try {

        res.json(
            yield User.query(req.query)
        )

    } catch (err) {
        next(err)
    }
})



app.post('/', App.json(), function * (req, res, next) {
    try {

        req.body.id= 0

        var user= yield User.post(req.body)
        if (user) {

            user.emails= yield UserEmail.push(user, req.body.emails)
            user.phones= yield UserPhone.push(user, req.body.phones)

            res.json(user)
        } else {
            res.json(user, 404)
        }

    } catch (err) {
        next(err)
    }
})



app.get('/:userId(\\d+)', function * (req, res, next) {
    try {

        var user= yield User.get({ id:req.param('userId') })
        if (user) {

            user.emails= yield UserEmail.query(user)
            user.phones= yield UserPhone.query(user)

            res.json(user)
        } else {
            res.json(user, 404)
        }

    } catch (err) {
        next(err)
    }
})



app.post('/:userId(\\d+)', App.json(), function * (req, res, next) {
    try {

        req.body.id= req.param('userId')

        if (req.body.deleted) {

            var user= yield User.del(req.body)
            if (user) {

                user.emails= yield UserEmail.del(user)
                user.phones= yield UserPhone.del(user)

                res.json(user)
            } else {
                res.json(user, 404)
            }

        } else {

            var user= yield User.patch(req.body)
            if (user) {

                user.emails= yield UserEmail.patch(user, req.body.emails)
                user.phones= yield UserPhone.patch(user, req.body.phones)

                res.json(user)
            } else {
                res.json(user, 404)
            }

        }

    } catch (err) {
        next(err)
    }
})
